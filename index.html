<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Etiquetas de Almacén con IA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Estilos generales de la aplicación */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f8f9fa;
        }
        .main-container {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
            position: relative;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #673AB7;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #512DA8;
            box-shadow: 0 8px 25px -8px #673AB7;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #FF9800;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #F57C00;
            box-shadow: 0 8px 25px -8px #FF9800;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        .input-field, .select-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            background-color: #f1f5f9;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
        }
        .tab.active {
            background-color: #673AB7;
            color: white;
            box-shadow: 0 4px 12px -4px #673AB7;
        }
        #drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 1.5rem;
            padding: 3rem;
            text-align: center;
        }
        #drop-zone.dragover {
            border-color: #673AB7;
            background-color: rgba(103, 58, 183, 0.05);
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #673AB7;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- ESTILOS PARA VISTA PREVIA E IMPRESIÓN --- */
        
        #print-preview-view {
            background-color: #e2e8f0;
        }

        #print-controls {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .print-page {
            width: 21.59cm;
            height: 27.94cm;
            padding: 0.762cm 2.59cm;
            box-sizing: border-box;
            display: grid;
            grid-template-columns: repeat(2, 8.14cm);
            grid-template-rows: repeat(6, 4.19cm);
            justify-content: center;
            gap: 0.246cm 0.254cm;
            background-color: white;
            margin: 2rem auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        .print-page:last-of-type {
            page-break-after: auto;
        }

        .label-print {
            border: 2pt solid #333;
            padding: 0.2cm;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 8pt;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .label-print-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 0.6cm;
            flex-shrink: 0;
        }
        .label-print-header img {
             height: 0.6cm;
             width: auto;
             max-width: 2.5cm;
        }
        .label-print-title {
            text-align: center;
            font-size: 8pt;
            line-height: 1.1;
            padding: 0 0.1cm;
        }
        .label-print-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 0;
        }
        .label-print-body p, .label-print-body .flex-line {
            margin: 0;
            font-weight: 700;
            border-bottom: 0.5px solid #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-bottom: 1px;
            font-size: 8.5pt;
        }
        .label-print-body p span, .label-print-body .flex-line span {
            font-weight: 400;
        }
        .label-print-body .flex-line {
            display: flex;
            justify-content: space-between;
        }
        .label-print-body .flex-line > div {
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
        }
        .label-print-body p:last-child {
            border-bottom: none;
        }


        @media print {
            body { background-color: white; }
            .main-container, #print-controls, #modal, #api-key-modal { display: none; }
            #print-preview-view { display: block; background-color: white; }
            .print-page { margin: 0; box-shadow: none; page-break-after: always; }
            .print-page:last-of-type { page-break-after: auto; }
            @page { size: letter; margin: 0; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="main-container">
        <div class="absolute top-4 right-4">
            <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 transition" title="Configuración">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </div>
        <header class="text-center my-8">
            <h1 class="text-4xl font-extrabold mt-4 text-gray-900">Generador de Etiquetas de Almacén con IA</h1>
            <p class="text-lg text-gray-600 mt-2">Crea etiquetas de forma rápida a partir de un vale o manualmente.</p>
        </header>

        <div class="flex justify-center space-x-2 my-8">
            <button id="tab-upload" class="tab active">Cargar Imagen</button>
            <button id="tab-manual" class="tab">Entrada Manual</button>
        </div>

        <div id="upload-view" class="card">
            <h2 class="text-2xl font-bold text-center mb-6">Paso 1: Sube la imagen del vale</h2>
            <div id="drop-zone">
                <p class="text-gray-500">Arrastra y suelta un archivo JPG o PNG aquí</p>
                <p class="my-2 text-gray-400 font-bold">o</p>
                <input type="file" id="file-input" class="hidden" accept="image/jpeg, image/png">
                <button id="browse-btn" class="btn btn-secondary">Seleccionar Archivo</button>
            </div>
            <div id="image-preview-container" class="mt-6 text-center hidden">
                <h3 class="font-bold text-lg">Imagen Cargada:</h3>
                <img id="image-preview" class="max-w-md mx-auto mt-2 rounded-lg shadow-md" />
                <button id="process-image-btn" class="btn btn-primary mt-4">Procesar con IA</button>
            </div>
        </div>
        <div id="manual-view" class="card hidden">
            <h2 class="text-2xl font-bold text-center mb-6">Añadir Partida Manualmente</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label for="manual-cantidad" class="font-semibold">Cantidad</label><input type="number" id="manual-cantidad" class="input-field mt-1" placeholder="Ej: 10"></div>
                <div><label for="manual-codigo-ax" class="font-semibold">Código AX</label><input type="text" id="manual-codigo-ax" class="input-field mt-1" placeholder="Ej: 1763"></div>
                <div class="md:col-span-2"><label for="manual-nombre" class="font-semibold">Nombre</label><input type="text" id="manual-nombre" class="input-field mt-1" placeholder="Ej: BOMBA HIDR. DE TRANSFERENCIA"></div>
                <div><label for="manual-dimension" class="font-semibold">Dimensión / Clave Almacén</label><input type="text" id="manual-dimension" class="input-field mt-1" placeholder="Ej: 312-7727"></div>
                <div><label for="manual-no-parte" class="font-semibold">No. Parte (Opcional)</label><input type="text" id="manual-no-parte" class="input-field mt-1" placeholder="Ej: Modelo XYZ-123"></div>
                <div class="md:col-span-2"><label for="manual-descripcion" class="font-semibold">Descripción (Opcional)</label><input type="text" id="manual-descripcion" class="input-field mt-1" placeholder="Información adicional"></div>
            </div>
            <div class="text-center mt-8"><button id="add-manual-item-btn" class="btn btn-primary">Añadir a la Lista de Revisión</button></div>
        </div>

        <div id="review-view" class="card mt-8 hidden">
             <h2 class="text-2xl font-bold text-center mb-2">Paso 2: Revisa, selecciona y edita las partidas</h2>
            <p class="text-center text-gray-600 mb-6">Modifica los datos si es necesario antes de imprimir.</p>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-4 rounded-l-lg"><input type="checkbox" id="select-all-checkbox"></th>
                            <th class="p-4 w-24">Cant.</th>
                            <th class="p-4">Código AX</th>
                            <th class="p-4">Nombre</th>
                            <th class="p-4">Dimensión</th>
                            <th class="p-4">No. Parte</th>
                            <th class="p-4">Descripción</th>
                            <th class="p-4">Condición</th>
                            <th class="p-4 rounded-r-lg">Categoría</th>
                        </tr>
                    </thead>
                    <tbody id="review-table-body"></tbody>
                </table>
            </div>
            <div class="text-center mt-8">
                <button id="prepare-print-btn" class="btn btn-primary text-lg">Ver Vista Previa de Impresión</button>
            </div>
        </div>
    </div>

    <div id="print-preview-view" class="hidden">
        <div id="print-controls" class="flex justify-center items-center space-x-4">
            <h2 class="text-xl font-bold">Vista Previa de Impresión</h2>
            <button id="print-now-btn" class="btn btn-primary">Imprimir Ahora</button>
            <button id="back-to-editor-btn" class="btn btn-secondary">Volver al Editor</button>
        </div>
        <div id="print-area" class="py-8"></div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="card text-center max-w-sm">
            <div id="loader" class="loader mx-auto hidden"></div>
            <p id="modal-message" class="text-lg font-semibold mt-4"></p>
        </div>
    </div>
    
    <div id="api-key-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="card text-left max-w-2xl w-full">
            <h2 class="text-2xl font-bold mb-4">Configuración</h2>
            <div class="space-y-6">
                <div>
                    <label for="api-key-input" class="font-semibold">API Key de Gemini</label>
                    <input type="password" id="api-key-input" class="input-field mt-1" placeholder="Pega tu API Key aquí">
                    <p class="text-sm text-gray-500 mt-1">Necesaria para el análisis de imágenes. Se guarda en tu navegador.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    <div>
                        <label class="font-semibold">Logo Izquierdo</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <input type="file" id="logo-left-file" class="hidden" accept="image/*">
                            <button onclick="document.getElementById('logo-left-file').click()" class="btn btn-secondary text-sm !px-4 !py-2">Subir Archivo</button>
                            <span class="text-gray-500">o</span>
                            <input type="text" id="logo-left-url" class="input-field" placeholder="Pegar URL">
                        </div>
                         <div class="mt-2 flex items-center space-x-2">
                            <img id="logo-left-preview" class="h-10 w-auto bg-gray-100 rounded">
                            <button id="clear-logo-left" class="text-red-500 hover:text-red-700 text-sm">Limpiar</button>
                        </div>
                    </div>
                    <div>
                        <label class="font-semibold">Logo Derecho</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <input type="file" id="logo-right-file" class="hidden" accept="image/*">
                            <button onclick="document.getElementById('logo-right-file').click()" class="btn btn-secondary text-sm !px-4 !py-2">Subir Archivo</button>
                             <span class="text-gray-500">o</span>
                            <input type="text" id="logo-right-url" class="input-field" placeholder="Pegar URL">
                        </div>
                        <div class="mt-2 flex items-center space-x-2">
                            <img id="logo-right-preview" class="h-10 w-auto bg-gray-100 rounded">
                            <button id="clear-logo-right" class="text-red-500 hover:text-red-700 text-sm">Limpiar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center mt-8">
                 <button id="clear-settings-btn" class="btn btn-danger">Borrar Toda la Configuración</button>
                 <div>
                    <button id="close-api-key-modal-btn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400 mr-2">Cerrar</button>
                    <button id="save-settings-btn" class="btn btn-primary">Guardar</button>
                 </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getEl = (id) => document.getElementById(id);
            const mainContainer = document.querySelector('.main-container');
            const tabUpload = getEl('tab-upload');
            const tabManual = getEl('tab-manual');
            const uploadView = getEl('upload-view');
            const manualView = getEl('manual-view');
            const reviewView = getEl('review-view');
            const dropZone = getEl('drop-zone');
            const fileInput = getEl('file-input');
            const browseBtn = getEl('browse-btn');
            const imagePreviewContainer = getEl('image-preview-container');
            const imagePreview = getEl('image-preview');
            const processImageBtn = getEl('process-image-btn');
            const reviewTableBody = getEl('review-table-body');
            const selectAllCheckbox = getEl('select-all-checkbox');
            const preparePrintBtn = getEl('prepare-print-btn');
            const addManualItemBtn = getEl('add-manual-item-btn');
            const modal = getEl('modal');
            const loader = getEl('loader');
            const modalMessage = getEl('modal-message');
            const printPreviewView = getEl('print-preview-view');
            const printArea = getEl('print-area');
            const printNowBtn = getEl('print-now-btn');
            const backToEditorBtn = getEl('back-to-editor-btn');
            
            const apiKeyModal = getEl('api-key-modal');
            const settingsBtn = getEl('settings-btn');
            const saveSettingsBtn = getEl('save-settings-btn');
            const closeApiKeyModalBtn = getEl('close-api-key-modal-btn');
            const clearSettingsBtn = getEl('clear-settings-btn');
            const apiKeyInput = getEl('api-key-input');
            const logoLeftUrlInput = getEl('logo-left-url');
            const logoRightUrlInput = getEl('logo-right-url');
            const logoLeftFileInput = getEl('logo-left-file');
            const logoRightFileInput = getEl('logo-right-file');
            const logoLeftPreview = getEl('logo-left-preview');
            const logoRightPreview = getEl('logo-right-preview');
            const clearLogoLeftBtn = getEl('clear-logo-left');
            const clearLogoRightBtn = getEl('clear-logo-right');

            const getSetting = (key) => localStorage.getItem(key);
            const setSetting = (key, value) => localStorage.setItem(key, value);
            const removeSetting = (key) => localStorage.removeItem(key);

            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });

            const openSettingsModal = () => {
                apiKeyInput.value = getSetting('geminiApiKey') || '';
                const logoLeft = getSetting('logoLeftUrl') || '';
                const logoRight = getSetting('logoRightUrl') || '';
                logoLeftUrlInput.value = logoLeft.startsWith('http') ? logoLeft : '';
                logoRightUrlInput.value = logoRight.startsWith('http') ? logoRight : '';
                logoLeftPreview.src = logoLeft;
                logoRightPreview.src = logoRight;
                apiKeyModal.classList.remove('hidden');
            };

            const saveSettings = async () => {
                const key = apiKeyInput.value.trim();
                if (key) setSetting('geminiApiKey', key);

                if (logoLeftFileInput.files[0]) {
                    setSetting('logoLeftUrl', await fileToBase64(logoLeftFileInput.files[0]));
                } else if (logoLeftUrlInput.value.trim()) {
                    setSetting('logoLeftUrl', logoLeftUrlInput.value.trim());
                }

                if (logoRightFileInput.files[0]) {
                    setSetting('logoRightUrl', await fileToBase64(logoRightFileInput.files[0]));
                } else if (logoRightUrlInput.value.trim()) {
                    setSetting('logoRightUrl', logoRightUrlInput.value.trim());
                }

                apiKeyModal.classList.add('hidden');
                showModal("Configuración guardada.", false, 2000);
            };

            const clearSettings = () => {
                removeSetting('geminiApiKey');
                removeSetting('logoLeftUrl');
                removeSetting('logoRightUrl');
                apiKeyInput.value = '';
                logoLeftUrlInput.value = '';
                logoRightUrlInput.value = '';
                logoLeftFileInput.value = '';
                logoRightFileInput.value = '';
                logoLeftPreview.src = '';
                logoRightPreview.src = '';
                showModal("Toda la configuración ha sido borrada.", false, 2000);
            };

            const setupLogoInput = (fileInput, urlInput, preview) => {
                fileInput.addEventListener('change', async () => {
                    if (fileInput.files[0]) {
                        urlInput.value = ''; 
                        preview.src = await fileToBase64(fileInput.files[0]);
                    }
                });
                urlInput.addEventListener('input', () => {
                    if (urlInput.value.trim()) {
                        fileInput.value = ''; 
                        preview.src = urlInput.value.trim();
                    }
                });
            };
            
            setupLogoInput(logoLeftFileInput, logoLeftUrlInput, logoLeftPreview);
            setupLogoInput(logoRightFileInput, logoRightUrlInput, logoRightPreview);

            clearLogoLeftBtn.addEventListener('click', () => {
                removeSetting('logoLeftUrl');
                logoLeftUrlInput.value = '';
                logoLeftFileInput.value = '';
                logoLeftPreview.src = '';
            });
            clearLogoRightBtn.addEventListener('click', () => {
                removeSetting('logoRightUrl');
                logoRightUrlInput.value = '';
                logoRightFileInput.value = '';
                logoRightPreview.src = '';
            });

            settingsBtn.addEventListener('click', openSettingsModal);
            saveSettingsBtn.addEventListener('click', saveSettings);
            clearSettingsBtn.addEventListener('click', clearSettings);
            closeApiKeyModalBtn.addEventListener('click', () => apiKeyModal.classList.add('hidden'));

            if (!getSetting('geminiApiKey')) {
                setTimeout(openSettingsModal, 500);
            }

            tabUpload.addEventListener('click', () => {
                tabUpload.classList.add('active');
                tabManual.classList.remove('active');
                uploadView.classList.remove('hidden');
                manualView.classList.add('hidden');
            });

            tabManual.addEventListener('click', () => {
                tabManual.classList.add('active');
                tabUpload.classList.remove('active');
                manualView.classList.remove('hidden');
                uploadView.classList.add('hidden');
            });

            browseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });

            function handleFile(file) {
                if (file && (file.type === 'image/jpeg' || file.type === 'image/png')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    showModal("Por favor, sube un archivo JPG o PNG.", false);
                }
            }
            
            function resetManualForm() {
                getEl('manual-cantidad').value = '';
                getEl('manual-codigo-ax').value = '';
                getEl('manual-nombre').value = '';
                getEl('manual-dimension').value = '';
                getEl('manual-no-parte').value = '';
                getEl('manual-descripcion').value = '';
            }

            processImageBtn.addEventListener('click', async () => {
                const apiKey = getSetting('geminiApiKey');
                if (!apiKey) {
                    showModal("Necesitas configurar tu API Key de Gemini primero.", false);
                    openSettingsModal();
                    return;
                }
                if (!imagePreview.src) {
                    showModal("Primero debes cargar una imagen.", false);
                    return;
                }
                showModal("Analizando el vale con IA...", true);
                try {
                    const base64ImageData = imagePreview.src.split(',')[1];
                    const prompt = `Analiza la siguiente imagen de un vale de material. Extrae la información de la tabla de materiales. Las columnas relevantes son 'CANTIDAD', 'CODIGO' (la segunda columna, no la que dice 'OC'), 'DESCRIPCION DEL MATERIAL', y 'CLAVE ALMACEN'. Devuelve el resultado como un array de objetos JSON. Asegúrate de que los valores de 'cantidad' sean numéricos.`;
                    const payload = {
                      contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64ImageData } }] }],
                      generation_config: {
                        response_mime_type: "application/json",
                        response_schema: {
                          type: "ARRAY",
                          items: {
                            type: "OBJECT",
                            properties: {
                              cantidad: { type: "NUMBER" },
                              codigo: { type: "STRING" },
                              descripcion: { type: "STRING" },
                              claveAlmacen: { type: "STRING" }
                            },
                            required: ["cantidad", "codigo", "descripcion", "claveAlmacen"]
                          }
                        }
                      }
                    };
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`Error en la API (${response.status}): ${response.statusText}. Revisa tu API Key.`); }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        const extractedData = JSON.parse(jsonText);
                        populateReviewTable(extractedData, true);
                        modal.classList.add('hidden');
                    } else { throw new Error("La IA no pudo extraer los datos. Intenta con una imagen más clara."); }
                } catch (error) {
                    console.error("Error al procesar con Gemini:", error);
                    showModal(`Error al contactar la IA. Detalles: ${error.message}`, false, 6000);
                }
            });

            addManualItemBtn.addEventListener('click', () => {
                const item = {
                    cantidad: getEl('manual-cantidad').value,
                    codigoAx: getEl('manual-codigo-ax').value,
                    nombre: getEl('manual-nombre').value,
                    dimension: getEl('manual-dimension').value,
                    noParte: getEl('manual-no-parte').value,
                    descripcion: getEl('manual-descripcion').value
                };
                if (!item.cantidad || !item.codigoAx || !item.nombre) {
                    showModal("Los campos Cantidad, Código AX y Nombre son obligatorios.", false);
                    return;
                }
                populateReviewTable([item], false);
                resetManualForm();
                showModal("Partida añadida a la lista de revisión.", false);
            });

            function populateReviewTable(items, clearTable) {
                if (clearTable) { reviewTableBody.innerHTML = ''; }
                items.forEach((item) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-purple-50';
                    row.innerHTML = `
                        <td class="p-4"><input type="checkbox" class="item-checkbox h-5 w-5 rounded text-purple-600 focus:ring-purple-500" checked></td>
                        <td class="p-2 w-24"><input type="number" class="input-field text-center font-bold" value="${item.cantidad || ''}"></td>
                        <td class="p-2"><input class="input-field" value="${item.codigo || item.codigoAx || ''}"></td>
                        <td class="p-2"><input class="input-field" value="${item.descripcion || item.nombre || ''}"></td>
                        <td class="p-2"><input class="input-field" value="${item.claveAlmacen || item.dimension || ''}"></td>
                        <td class="p-2"><input class="input-field" value="${item.noParte || ''}"></td>
                        <td class="p-2"><input class="input-field" value="${item.descripcion || ''}"></td>
                        <td class="p-2">
                            <select class="select-field">
                                <option>NUEVO</option>
                                <option>USADO NUEVO</option>
                            </select>
                        </td>
                        <td class="p-2">
                            <select class="select-field">
                                <option>INVENTARIABLE</option>
                                <option>CONSUMIBLE</option>
                            </select>
                        </td>
                    `;
                    reviewTableBody.appendChild(row);
                });
                reviewView.classList.remove('hidden');
                window.scrollTo({ top: reviewView.offsetTop, behavior: 'smooth' });
            }

            selectAllCheckbox.addEventListener('change', (e) => {
                document.querySelectorAll('.item-checkbox').forEach(cb => { cb.checked = e.target.checked; });
            });
            
            preparePrintBtn.addEventListener('click', () => {
                const selectedRows = Array.from(reviewTableBody.querySelectorAll('tr')).filter(row => 
                    row.querySelector('.item-checkbox').checked
                );
                if (selectedRows.length === 0) {
                    showModal("No has seleccionado ninguna partida para generar etiquetas.", false);
                    return;
                }
                showModal("Preparando vista previa...", true);
                printArea.innerHTML = '';
                let currentPage;
                let labelCount = 0;
                selectedRows.forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    const selects = row.querySelectorAll('select');
                    const labelData = {
                        cantidad: parseInt(inputs[1].value, 10) || 0,
                        codigoAx: inputs[2].value,
                        nombre: inputs[3].value,
                        dimension: inputs[4].value,
                        noParte: inputs[5].value,
                        descripcion: inputs[6].value,
                        condicion: selects[0].value,
                        categoria: selects[1].value
                    };
                    for (let i = 0; i < labelData.cantidad; i++) {
                        if (labelCount % 12 === 0) {
                            currentPage = document.createElement('div');
                            currentPage.className = 'print-page';
                            printArea.appendChild(currentPage);
                        }
                        currentPage.appendChild(createLabelElement(labelData));
                        labelCount++;
                    }
                });
                setTimeout(() => {
                    modal.classList.add('hidden');
                    mainContainer.classList.add('hidden');
                    printPreviewView.classList.remove('hidden');
                    window.scrollTo(0, 0);
                }, 500);
            });

            printNowBtn.addEventListener('click', () => window.print());
            backToEditorBtn.addEventListener('click', () => {
                printPreviewView.classList.add('hidden');
                mainContainer.classList.remove('hidden');
            });

            function createLabelElement(data) {
                const label = document.createElement('div');
                label.className = 'label-print';
                const safeData = Object.fromEntries(Object.entries(data).map(([key, value]) => [key, document.createTextNode(value).textContent]));
                
                const logoLeftUrl = getSetting('logoLeftUrl') || '';
                const logoRightUrl = getSetting('logoRightUrl') || '';
                const logoLeftImg = logoLeftUrl ? `<img src="${logoLeftUrl}" alt="Logo Izquierdo">` : '<div></div>';
                const logoRightImg = logoRightUrl ? `<img src="${logoRightUrl}" alt="Logo Derecho">` : '<div></div>';

                label.innerHTML = `
                    <div class="label-print-header">
                        ${logoLeftImg}
                        <div class="label-print-title">
                            <strong>ETIQUETADO ALMACEN</strong><br>
                            <span>BRONCO RIG-91</span>
                        </div>
                        ${logoRightImg}
                    </div>
                    <div class="label-print-body">
                        <div class="flex-line">
                            <div><strong>CODIGO AX:</strong> <span>${safeData.codigoAx}</span></div>
                            <div><strong>CONDICION:</strong> <span>${safeData.condicion}</span></div>
                        </div>
                        <p><strong>NOMBRE:</strong> <span>${safeData.nombre}</span></p>
                        <p><strong>DIMENSIÓN:</strong> <span>${safeData.dimension}</span></p>
                        <p><strong>DESCRIPCION:</strong> <span>${safeData.descripcion}</span></p>
                        <p><strong>NO. PARTE:</strong> <span>${safeData.noParte}</span></p>
                        <p><strong>CATEGORIA:</strong> <span>${safeData.categoria}</span></p>
                    </div>
                `;
                return label;
            }

            function showModal(message, showLoader = false, duration = 4000) {
                modalMessage.textContent = message;
                if(loader) loader.style.display = showLoader ? 'block' : 'none';
                modal.classList.remove('hidden');
                if (!showLoader) {
                    setTimeout(() => modal.classList.add('hidden'), duration);
                }
            }
        });
    </script>
</body>
</html>
