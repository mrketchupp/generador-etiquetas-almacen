// ============ STORAGE PERSISTENCE REAL ============
const STORAGE_KEYS = {
    logoLeft: 'logoLeft',
    logoRight: 'logoRight',
    codigosAX: 'codigosAX',
    headerText: 'headerText'
};

// ============ GLOBAL VARIABLES ============
let currentMode = 'material';
let materials = [];
let codigoaxItems = [];
let logoLeft = localStorage.getItem(STORAGE_KEYS.logoLeft);
let logoRight = localStorage.getItem(STORAGE_KEYS.logoRight);
let headerText = localStorage.getItem(STORAGE_KEYS.headerText) || 'BRONCO RIG-91';
let codigosData = {};

const condicionOptions = ['NUEVO', 'USADO NUEVO', 'RESGUARDO'];
const categoriaOptions = ['INVENTARIABLE', 'CONSUMIBLES'];

function initCodigosData() {
  const storedData = localStorage.getItem(STORAGE_KEYS.codigosAX);
  if (storedData) {
    try {
      codigosData = JSON.parse(storedData);
      console.log('CSV data loaded from storage:', Object.keys(codigosData).length, 'entries');
    } catch (e) {
      console.error('Error parsing CSV data:', e);
      codigosData = {};
    }
  } else {
    codigosData = {};
    console.log('No CSV data in storage - starting empty');
  }
  updateCSVStatus();
}

window.addEventListener('DOMContentLoaded', function() {
    console.log('=== Page loaded, initializing configuration ===');
    if (logoLeft) {
        updateLogoPreview('left', logoLeft);
        const leftInput = document.getElementById('leftLogoUrl');
        if (leftInput) leftInput.value = logoLeft;
    }
    if (logoRight) {
        updateLogoPreview('right', logoRight);
        const rightInput = document.getElementById('rightLogoUrl');
        if (rightInput) rightInput.value = logoRight;
    }
    initCodigosData();
    const hasConfiguration = logoLeft || logoRight || Object.keys(codigosData).length > 0;
    if (!hasConfiguration) {
        console.log('First time user - opening configuration modal');
        setTimeout(() => {
            openConfigModal();
        }, 500);
    }
    console.log('Configuration restored:', {
        logoLeft: logoLeft ? 'exists' : 'empty',
        logoRight: logoRight ? 'exists' : 'empty',
        csvEntries: Object.keys(codigosData).length
    });
});

function updateCSVStatus() {
    const statusElement = document.getElementById('csvStatus');
    const count = Object.keys(codigosData).length;
    if (statusElement) {
        if (count > 0) {
            statusElement.textContent = count + ' c칩digos AX cargados';
            statusElement.style.color = '#22c55e';
        } else {
            statusElement.textContent = '';
            statusElement.style.color = '#999';
        }
    }
}

// CSV upload and management
function handleCSVUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const csvText = e.target.result;
            const parsedData = parseCSV(csvText);
            if (Object.keys(parsedData).length > 0) {
                codigosData = parsedData;
                localStorage.setItem(STORAGE_KEYS.codigosAX, JSON.stringify(codigosData));
                updateCSVStatus();
                alert('Archivo CSV cargado exitosamente. ' + Object.keys(codigosData).length + ' c칩digos disponibles.');
                console.log('CSV uploaded and saved to storage');
            } else {
                alert('No se encontraron datos v치lidos en el CSV');
            }
        };
        reader.readAsText(file);
    }
}
function clearCSV() {
    codigosData = {};
    localStorage.removeItem(STORAGE_KEYS.codigosAX);
    document.getElementById('csvFile').value = '';
    updateCSVStatus();
    alert('CSV eliminado.');
    console.log('CSV cleared from storage');
}
function parseCSV(csv) {
    const lines = csv.trim().split('\n');
    const codigosMap = {};
    if (lines.length < 2) return codigosMap;
    const header = lines[0].split(',').map(h => h.trim().toLowerCase());
    const codigoaxIndex = header.findIndex(h => h.includes('codigo') && h.includes('ax'));
    const nombreIndex = header.findIndex(h => h.includes('nombre'));
    if (codigoaxIndex === -1 || nombreIndex === -1) return codigosMap;
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim() === '') continue;
        const parts = lines[i].split(',').map(p => p.trim());
        const codigoax = parts[codigoaxIndex];
        const nombre = parts[nombreIndex];
        if (codigoax && nombre) {
            codigosMap[codigoax.toUpperCase()] = nombre;
        }
    }
    return codigosMap;
}
function autocompleteNombre(codigoaxValue) {
    const codigoax = codigoaxValue.trim().toUpperCase();
    return codigosData[codigoax] || null;
}
function updateHeaderText() {
    const input = document.getElementById('headerText');
    if (input) {
        headerText = input.value || 'BRONCO RIG-91';
        localStorage.setItem(STORAGE_KEYS.headerText, headerText);
        console.log('Header text actualizado a:', headerText);
    }
}
function handleLogoUpload(event, side) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const dataUrl = e.target.result;
            if (side === 'left') {
                logoLeft = dataUrl;
                localStorage.setItem(STORAGE_KEYS.logoLeft, logoLeft);
                updateLogoPreview('left', logoLeft);
            } else {
                logoRight = dataUrl;
                localStorage.setItem(STORAGE_KEYS.logoRight, logoRight);
                updateLogoPreview('right', logoRight);
            }
            console.log(`Logo ${side} uploaded and saved to storage`);
        };
        reader.readAsDataURL(file);
    }
}
function handleLogoUrl(event, side) {
    const url = event.target.value;
    if (url) {
        if (side === 'left') {
            logoLeft = url;
            localStorage.setItem(STORAGE_KEYS.logoLeft, logoLeft);
            updateLogoPreview('left', logoLeft);
        } else {
            logoRight = url;
            localStorage.setItem(STORAGE_KEYS.logoRight, logoRight);
            updateLogoPreview('right', logoRight);
        }
        console.log(`Logo ${side} URL saved to storage`);
    }
}
function clearLogo(side) {
    if (side === 'left') {
        logoLeft = '';
        localStorage.removeItem(STORAGE_KEYS.logoLeft);
        const leftInput = document.getElementById('leftLogoUrl');
        if (leftInput) leftInput.value = '';
        const leftPreview = document.getElementById('leftLogoPreview');
        if (leftPreview) {
            leftPreview.innerHTML = 'Sin logo configurado';
            leftPreview.classList.add('empty');
        }
    } else {
        logoRight = '';
        localStorage.removeItem(STORAGE_KEYS.logoRight);
        const rightInput = document.getElementById('rightLogoUrl');
        if (rightInput) rightInput.value = '';
        const rightPreview = document.getElementById('rightLogoPreview');
        if (rightPreview) {
            rightPreview.innerHTML = 'Sin logo configurado';
            rightPreview.classList.add('empty');
        }
    }
    console.log(`Logo ${side} cleared from storage`);
}
function updateLogoPreview(side, logoUrl) {
    const previewId = side === 'left' ? 'leftLogoPreview' : 'rightLogoPreview';
    const preview = document.getElementById(previewId);
    if (preview && logoUrl) {
        preview.innerHTML = `<img src="${logoUrl}" alt="Logo ${side}">`;
        preview.classList.remove('empty');
    } else if (preview) {
        preview.innerHTML = 'Sin logo configurado';
        preview.classList.add('empty');
    }
}
function saveLogoConfig() {
    alert('Configuraci칩n guardada');
    closeConfigModal();
}
